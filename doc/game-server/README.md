# リアルタイムゲームサーバー RPC API リファレンス
このAPIリファレンスでは、リアルタイム通信に用いるゲームサーバーのAPIを説明します。

エンドポイントの役割別に、`Connection`と`Streaming`の2種類のリクエストタイプに分類しています。

## Connection
`Connection`はゲームサーバーへの接続に関するリクエストを担います。
他のエンドポイントに接続する前に、クライアントはこれらのリクエストを通してサーバーに**接続する**必要があります。

### データ型

### ConnectionRequest
`ConnectionRequest`は`Connection`タイプのエンドポイントへリクエストを行う際に用いられる共通の型です。

なお、`sessionToken`に関しては、`Connect`エンドポイントへの接続時のみ有効であればよいです。
接続後はトークン自体をキャッシュし、それら自体が識別子として機能します。

| パラメーター名 | タイプ | 必須  | 説明                             |
| :------------- | :----: | :---: | :------------------------------- |
| sessionToken   | String | true  | 接続の認証に用いるトークンです。 |


### ConnectionResponce
`ConnectionResponce`は`Connection`タイプのエンドポイントのリクエストの返答として用いられる共通の型です。

| パラメーター名 |        タイプ        | 説明                         |
| :------------- | :------------------: | :--------------------------- |
| Status         | ConnectionStatusEnum | 操作後の接続状況を表します。 |

### ConnectionStatusEnum
`ConnectionStatusEnum`は接続状況を表す共通の列挙型です。

| 値                     | セッションが有効 | 説明                                                     |
| :--------------------- | :--------------: | :------------------------------------------------------- |
| CONNECTION_UNSPECIFIED |      false       | 異常な値です。該当する値がない場合に用いられます。       |
| CONNECTING             |      false       | 接続処理中です。再度接続状況を確認する必要があります。   |
| CONNECTED              |       true       | セッションが有効です                                     |
| DISCONNECTED_BY_CLIENT |      false       | クライアントによる要求により、セッションは終了済みです。 |
| DISCONNECTED_BY_SERVER |      false       | サーバー側からの処理により、セッションは終了済みです。   |
| DISCONNECTED           |      false       | セッションは終了済みです。                               |
| CONNECTION_FAIL        |      false       | 接続に失敗しました。CONNECTINGから遷移します。           |

## Connection エンドポイント

## Connect
サーバーへの接続を要求します。

リクエストに成功すると、コネクションステータスが`CONNECTED`に遷移します。
ただし、将来的にはリクエストの処理に遅延評価が必要な場合等に`CONNECTING`に遷移する可能性があることを考慮してください。


| リクエスト        | レスポンス         |
| :---------------- | :----------------- |
| ConnectionRequest | ConnectionResponce |

### 前提条件

| 条件         |            要求            |
| :----------- | :------------------------: |
| ステータス   | セッションが無効であること |
| sessionToken |  トークンが有効であること  |

### エラー

| エラー名          | gRPCステータスコード | 説明                                                                | 対応                                                               |
| :---------------- | :------------------: | :------------------------------------------------------------------ | :----------------------------------------------------------------- |
| AuthAPIThrowError |   UNAUTHENTICATED    | 認証に係るデータを取得したところ、API側からエラーを受け取りました。 | sessionTokenの有効性を確認してください                             |
| Unauthorized      |  PERMISSION_DENIED   | ゲームへの接続が許可されていませんでした。                          | 正しいサーバーへ接続しているか確認してください                     |
| InvalidOperation  | FAILED_PRECONDITION  | 無効な操作です。                                                    | すでに接続済みである可能性があります。ステータスを確認してください |
| InvalidArgument   |   INVALID_ARGUMENT   | リクエストの引数が不適切です。                                      | 制約に違反するパラメーターがないか確認してください                 |
| APIConnectionLost |       INTERNAL       | APIサーバーへの接続に失敗しました。                                 | 何度も起こる場合、このサーバーへの接続を破棄してください。         |


## Disconnect
サーバーからの切断を要求します。

リクエストに成功すると、コネクションステータスが`DISCONNECTED_BY_CLIENT`に遷移します。

| リクエスト        | レスポンス         |
| :---------------- | :----------------- |
| ConnectionRequest | ConnectionResponce |

### 前提条件

| 条件       |            要求            |
| :--------- | :------------------------: |
| ステータス | セッションが有効であること |

### エラー

| エラー名         | gRPCステータスコード | 説明                             | 対応                                                                                   |
| :--------------- | :------------------: | :------------------------------- | :------------------------------------------------------------------------------------- |
| SessionNotActive |  PERMISSION_DENIED   | 有効なセッションが見つかりません | 切断を試みるには、ステータスが有効である必要があります。ステータスを確認してください。 |
| InvalidOperation | FAILED_PRECONDITION  | 無効な操作です。                 | 切断を試みるには、ステータスが有効である必要があります。ステータスを確認してください。 |
| InvalidArgument  |   INVALID_ARGUMENT   | リクエストの引数が不適切です。   | 制約に違反するパラメーターがないか確認してください                                     |


## GetConnectionStatus
該当トークンの、サーバーへの接続状況を返します。
コネクションステータスの遷移はありません。

このサーバーでは、接続状況を切断後30分維持します。ただし、新しい試合が始まった場合等に接続状況のデータをすべて破棄することがあります。

> サーバーは、`CONNECTING`及び`CONNECTED`以外の状態であるセッションの状況を再度有効にすることはありません。  
> (`DISCONNECTED_BY_SERVER`が`DISCONNECTED`に遷移する等、システム的にステータスを置き換えることはあります)  
> したがって、クライアントはステータスが`CONNECTING`及び`CONNECTED`以外の場合に、他のエンドポイントにアクセスするまで再度ステータスを取得する必要はありません。  
> ステータスを定期的にポーリングする場合、その間隔は最低1秒確保するよう努めてください。  

| リクエスト        | レスポンス         |
| :---------------- | :----------------- |
| ConnectionRequest | ConnectionResponce |

### 前提条件

| 条件         |                      要求                      |
| :----------- | :--------------------------------------------: |
| sessionToken | このトークンを用いて接続を試みたことがあること |

### エラー

| エラー名        | gRPCステータスコード | 説明                           | 対応                                                                                   |
| :-------------- | :------------------: | :----------------------------- | :------------------------------------------------------------------------------------- |
| NoStatusFound   |      NOT_FOUND       | セッションが見つかりません     | 過去に接続を試みたことがあるか、切断してから時間が立ちすぎていないか確認してください。 |
| InvalidArgument |   INVALID_ARGUMENT   | リクエストの引数が不適切です。 | 制約に違反するパラメーターがないか確認してください                                     |


## Streaming
`Streaming`はゲームに関わる情報のリアルタイムストリーミングを担います。

### ヌル。
まだないよ。